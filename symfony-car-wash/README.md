# üöó Errekalde Car Wash - Symfony Edition

Sistema profesional de reservas de lavado de coches con **sincronizaci√≥n en tiempo real** entre dispositivos usando **Symfony 6.4**, **MariaDB** y **WebSockets (Mercure)**.

![Symfony](https://img.shields.io/badge/Symfony-6.4-000000?style=for-the-badge&logo=symfony)
![PHP](https://img.shields.io/badge/PHP-8.3+-777BB4?style=for-the-badge&logo=php)
![MariaDB](https://img.shields.io/badge/MariaDB-11.8+-003545?style=for-the-badge&logo=mariadb)
![Bootstrap](https://img.shields.io/badge/Bootstrap-5.3-7952B3?style=for-the-badge&logo=bootstrap)
![Mercure](https://img.shields.io/badge/Mercure-WebSockets-FF6B35?style=for-the-badge)

## üéØ Caracter√≠sticas Principales

### ‚úÖ **Base de Datos Centralizada Universal**
- **MariaDB/MySQL** como √∫nica fuente de verdad
- **Transacciones ACID** para integridad de datos
- **Operaciones at√≥micas** para prevenir condiciones de carrera
- **√çndices optimizados** para consultas r√°pidas

### ‚úÖ **Sincronizaci√≥n en Tiempo Real**
- **WebSockets con Mercure** para notificaciones instant√°neas
- **Sincronizaci√≥n autom√°tica** entre dispositivos en **3-5 segundos**
- **Detecci√≥n de cambios** y notificaciones push
- **Reconexi√≥n autom√°tica** en caso de p√©rdida de conexi√≥n

### ‚úÖ **Prevenci√≥n de Reservas Duplicadas**
- **Control de concurrencia** a nivel de base de datos
- **Bloqueos optimistas** para operaciones cr√≠ticas
- **Validaci√≥n en tiempo real** de disponibilidad
- **Rollback autom√°tico** en caso de conflictos

### ‚úÖ **Arquitectura Profesional**
- **Symfony 6.4** con mejores pr√°cticas
- **Doctrine ORM** para manejo de datos
- **Repository pattern** para consultas optimizadas
- **Service layer** para l√≥gica de negocio
- **Command pattern** para tareas administrativas

### ‚úÖ **Frontend Moderno**
- **Twig templates** con **Bootstrap 5**
- **JavaScript vanilla** optimizado
- **Responsive design** para m√≥viles, tablets y desktop
- **Indicadores visuales** de estado de sincronizaci√≥n (üü¢üü°üî¥)

### ‚úÖ **Integraci√≥n WhatsApp**
- **C√≥digos de verificaci√≥n** autom√°ticos
- **Confirmaciones de reserva** por WhatsApp
- **Integraci√≥n con N8N** para notificaciones

## üèóÔ∏è Arquitectura del Sistema

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     FRONTEND P√öBLICO                        ‚îÇ
‚îÇ              https://errekalde-car-wash.surge.sh/          ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  [Mobile] [Tablet] [Desktop] ‚îÄ‚îÄ‚îê                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  SYMFONY BACKEND API                       ‚îÇ
‚îÇ                    (Tu Servidor)                           ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ Controllers ‚îÇ  ‚îÇ  Services   ‚îÇ  ‚îÇ Repositories‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îÇ
‚îÇ  ‚îÇ   Entities  ‚îÇ  ‚îÇ  Mercure    ‚îÇ  ‚îÇ   Commands  ‚îÇ        ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                     ‚îÇ                            ‚îÇ
                     ‚ñº                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          MARIADB                ‚îÇ  ‚îÇ    MERCURE HUB      ‚îÇ
‚îÇ      (Base de Datos             ‚îÇ  ‚îÇ   (WebSockets)      ‚îÇ
‚îÇ       Centralizada)             ‚îÇ  ‚îÇ                     ‚îÇ
‚îÇ                                 ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ  ‚îÇ  ‚îÇ Real-time   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ available_spaces        ‚îÇ    ‚îÇ  ‚îÇ  ‚îÇ Sync        ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ reservations           ‚îÇ    ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üöÄ Instalaci√≥n R√°pida

### Opci√≥n 1: Instalaci√≥n Automatizada (Linux/macOS)
```bash
# Clonar repositorio
git clone [URL] symfony-car-wash
cd symfony-car-wash

# Ejecutar instalaci√≥n automatizada
chmod +x install.sh
./install.sh

# Iniciar sistema completo
./start-system.sh
```

### Opci√≥n 2: Instalaci√≥n Manual
```bash
# 1. Instalar dependencias
composer install

# 2. Configurar base de datos
cp .env.example .env
mysql -u root -e "CREATE DATABASE errekalde_car_wash"

# 3. Ejecutar migraciones
php bin/console doctrine:migrations:migrate

# 4. Inicializar espacios
php bin/console car-wash:initialize

# 5. Iniciar servicios
./mercure run --config Caddyfile &  # Terminal 1
symfony server:start --port=8000    # Terminal 2
```

## üìä Esquema de Base de Datos

### Tabla: `available_spaces`
```sql
CREATE TABLE available_spaces (
    id INT AUTO_INCREMENT PRIMARY KEY,
    date DATE NOT NULL UNIQUE,
    available_spaces INT NOT NULL,
    total_spaces INT NOT NULL,
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    is_active BOOLEAN DEFAULT TRUE,
    INDEX idx_date (date)
);
```

### Tabla: `reservations`
```sql
CREATE TABLE reservations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    reservation_id VARCHAR(255) NOT NULL UNIQUE,
    available_space_id INT,
    date DATE NOT NULL,
    client_name VARCHAR(255) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    car_brand VARCHAR(100) NOT NULL,
    car_model VARCHAR(100) NOT NULL,
    car_size ENUM('small', 'medium', 'large') NOT NULL,
    services JSON NOT NULL,
    service_names JSON NOT NULL,
    price DECIMAL(8,2) NOT NULL,
    status ENUM('pending', 'confirmed', 'cancelled', 'completed') DEFAULT 'pending',
    is_verified BOOLEAN DEFAULT FALSE,
    verification_code VARCHAR(6),
    device_id VARCHAR(50),
    created_at DATETIME NOT NULL,
    updated_at DATETIME NOT NULL,
    INDEX idx_date (date),
    INDEX idx_phone (phone),
    INDEX idx_status (status),
    FOREIGN KEY (available_space_id) REFERENCES available_spaces(id)
);
```

## üîÑ Flujo de Sincronizaci√≥n

### 1. Usuario Hace Reserva
```php
// ReservationService::createReservation()
$this->entityManager->beginTransaction();

// Bloquear fila para evitar condiciones de carrera
$space = $this->getAvailableSpaceWithLock($date);

// Decrementar espacios de forma at√≥mica
$this->spaceRepository->decrementSpaces($date);

// Publicar actualizaci√≥n en tiempo real
$this->syncService->publishSpaceUpdate($space);

$this->entityManager->commit();
```

### 2. Otros Dispositivos Se Actualizan
```javascript
// car-wash-app.js
mercureEventSource.onmessage = (event) => {
    const data = JSON.parse(event.data);
    
    if (data.type === 'space_update') {
        this.espaciosGlobales[data.space.date] = data.space.availableSpaces;
        this.renderCalendar(); // Re-renderizar con nuevos datos
        this.showNotification('Espacios actualizados en tiempo real');
    }
};
```

### 3. Base de Datos Siempre Consistente
```php
// AvailableSpaceRepository::decrementSpaces()
$sql = '
    UPDATE available_spaces 
    SET available_spaces = available_spaces - 1, 
        updated_at = NOW() 
    WHERE date = :date 
      AND available_spaces > 0 
      AND is_active = 1
';
// Operaci√≥n at√≥mica que previene overselling
```

## üõ†Ô∏è API Endpoints

### Espacios Disponibles
```bash
# Obtener todos los espacios
GET /api/espacios

# Obtener espacios por fecha
GET /api/espacios/2025-07-16

# Sincronizaci√≥n global
GET /api/sync-espacios
```

### Reservas
```bash
# Crear reserva
POST /api/reservar
{
  "date": "2025-07-16",
  "clientName": "Juan P√©rez",
  "phone": "+34600000000",
  "carBrand": "Toyota",
  "carModel": "Corolla",
  "carSize": "medium",
  "services": ["complete"],
  "price": 25
}

# Verificar c√≥digo
POST /api/verificar
{
  "phone": "+34600000000",
  "code": "123456"
}

# Cancelar reserva
DELETE /api/cancelar/{reservationId}
```

### Administraci√≥n
```bash
# Estad√≠sticas del sistema
GET /api/estadisticas

# Health check
GET /api/health

# Configuraci√≥n Mercure
GET /api/mercure-config

# Resetear espacios
POST /api/reset-espacios
{
  "spaces": 8
}
```

## üîß Comandos de Consola

```bash
# Inicializar sistema
php bin/console car-wash:initialize --weeks=12 --spaces=8

# Resetear todos los espacios
php bin/console car-wash:initialize --reset --spaces=8

# Ejecutar migraciones
php bin/console doctrine:migrations:migrate

# Limpiar cache
php bin/console cache:clear

# Validar esquema
php bin/console doctrine:schema:validate

# Ver rutas disponibles
php bin/console debug:router
```

## üåê Configuraci√≥n para URL P√∫blica

Para conectar `https://errekalde-car-wash.surge.sh/` con tu servidor:

### 1. Configurar Backend
```bash
# En .env
FRONTEND_URL=https://errekalde-car-wash.surge.sh
CORS_ALLOW_ORIGIN=https://errekalde-car-wash.surge.sh
MERCURE_PUBLIC_URL=https://tu-servidor.com:3000/.well-known/mercure
```

### 2. Actualizar Frontend P√∫blico
```javascript
// En https://errekalde-car-wash.surge.sh/
window.APP_CONFIG = {
    apiBaseUrl: 'https://tu-servidor.com/api',
    mercureConfig: {
        mercure_url: 'https://tu-servidor.com:3000/.well-known/mercure'
    }
};
```

### 3. Configurar HTTPS
```bash
# Con Let's Encrypt
sudo certbot --apache -d tu-servidor.com

# O configurar proxy reverso
# nginx.conf / apache.conf
```

## üì± Funcionalidades por Dispositivo

### üñ•Ô∏è **Desktop**
- Interfaz completa con calendario interactivo
- Navegaci√≥n por pasos optimizada
- Indicadores de sincronizaci√≥n en tiempo real
- Panel de administraci√≥n (opcional)

### üì± **Mobile**
- Dise√±o responsive optimizado para t√°ctil
- Calendario adaptado a pantalla peque√±a
- Formularios simplificados
- Notificaciones push via WebSockets

### üì± **Tablet**
- H√≠brido entre desktop y mobile
- Aprovecha espacio de pantalla disponible
- Interacciones t√°ctiles optimizadas
- Vista de calendario expandida

## üîç Monitoreo y Debugging

### Logs de Aplicaci√≥n
```bash
# Ver logs en tiempo real
tail -f var/log/dev.log

# Filtrar solo errores
tail -f var/log/prod.log | grep ERROR

# Ver logs de Doctrine
tail -f var/log/dev.log | grep doctrine
```

### Verificar Estado del Sistema
```bash
# Health check completo
curl http://localhost:8000/api/health

# Verificar Mercure
curl http://localhost:3000/.well-known/mercure

# Estad√≠sticas de uso
curl http://localhost:8000/api/estadisticas
```

### Debug de Base de Datos
```sql
-- Ver espacios actuales
SELECT date, available_spaces, total_spaces, updated_at 
FROM available_spaces 
WHERE is_active = 1 
ORDER BY date;

-- Ver reservas recientes
SELECT reservation_id, client_name, date, status, created_at 
FROM reservations 
WHERE created_at >= DATE_SUB(NOW(), INTERVAL 24 HOUR) 
ORDER BY created_at DESC;

-- Verificar integridad
SELECT 
    a.date,
    a.total_spaces,
    a.available_spaces,
    COUNT(r.id) as confirmed_reservations,
    (a.total_spaces - a.available_spaces) as expected_reservations
FROM available_spaces a
LEFT JOIN reservations r ON a.date = r.date AND r.status = 'confirmed'
WHERE a.is_active = 1
GROUP BY a.id
HAVING confirmed_reservations != expected_reservations;
```

## üéØ Ventajas vs Sistema Anterior

| Aspecto | Sistema Anterior (N8N/Node.js) | Sistema Nuevo (Symfony/MariaDB) |
|---------|--------------------------------|----------------------------------|
| **Base de Datos** | localStorage + N8N Variables | MariaDB Centralizada |
| **Concurrencia** | Sin control de concurrencia | Transacciones ACID + Bloqueos |
| **Consistencia** | Eventually consistent | Inmediatamente consistente |
| **Escalabilidad** | Limitada por N8N | Escalable horizontalmente |
| **Mantenimiento** | C√≥digo JavaScript distribuido | Arquitectura estructurada |
| **Testing** | Dif√≠cil de testear | PHPUnit + Tests automatizados |
| **Debugging** | Console logs b√°sicos | Logs estructurados + Profiler |
| **Performance** | Dependiente de webhooks | Consultas SQL optimizadas |

## üöÄ Roadmap Futuro

- [ ] **Panel de Administraci√≥n Web** completo
- [ ] **API REST completa** para integraciones
- [ ] **Notificaciones Push** nativas
- [ ] **Reportes y Analytics** avanzados
- [ ] **Sistema de Descuentos** configurable
- [ ] **Integraci√≥n con Calendarios** (Google, Outlook)
- [ ] **Multi-tenancy** para m√∫ltiples empresas
- [ ] **App M√≥vil Nativa** (React Native/Flutter)

## üìû Soporte y Contribuci√≥n

### Reportar Issues
1. Verificar logs: `var/log/`
2. Reproducir el problema
3. Crear issue con detalles completos

### Contribuir
1. Fork del repositorio
2. Crear rama feature: `git checkout -b feature/nueva-funcionalidad`
3. Commit cambios: `git commit -m 'feat: nueva funcionalidad'`
4. Push: `git push origin feature/nueva-funcionalidad`
5. Crear Pull Request

## üìÑ Licencia

MIT License - Ver archivo `LICENSE` para m√°s detalles.

---

## üéâ ¬°Sistema Listo!

**Tu nuevo sistema de reservas con Symfony est√° completamente configurado para:**

‚úÖ **Sincronizaci√≥n en tiempo real** entre todos los dispositivos  
‚úÖ **Base de datos centralizada** que previene reservas duplicadas  
‚úÖ **Arquitectura escalable** y profesional  
‚úÖ **Integraci√≥n perfecta** con tu URL p√∫blica  

**¬°Disfruta de un sistema de reservas verdaderamente profesional!** üöó‚ú® 